language: node_js
node_js: "stable"
cache: npm
env:
  - NODE_ENV=travis
jobs:
  include:
    - stage: "Tests"
      name: "Unit Tests"
      script: jest --coverage --coverageReporters=text-lcov | coveralls
    - script: npm run lint
      name: "Lint"
    - script: npm run test:e2e
      name: "Integration Tests"
      services:
        - mongodb
      before_script: mongo shassi_ci --eval 'db.createUser({user:"admin", pwd:"admin", roles:["readWrite"]});'
    - stage: "Sonarcloud"
      script:
        - npm run test:cov
        - sonar-scanner
      addons:
        sonarcloud:
          organization: "kiwikern-github"
          token: $SONAR_TOKEN
    - stage: "Deployment"
      skip_cleanup: true
      provider: script
      script: sshpass -p $DEPLOY_SSH_PASSWORD ssh -o StrictHostKeyChecking=no $DEPLOY_SSH_USER@$DEPLOY_SSH_HOST -t "$DEPLOY_SSH_PATH/deployment.sh"
      on:
        tags: true

